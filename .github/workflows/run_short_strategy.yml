name: 24h Short Strategy Bot

on:
  schedule:
    # æ¯å°æ—¶çš„ 0, 15, 30, 45 åˆ†è¿è¡Œ
    - cron: '0,15,30,45 * * * *'
  workflow_dispatch:

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
          fetch-depth: 1 

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Start Xray Proxy
      run: |
        # ä½¿ç”¨ -O è¦†ç›–ä¸‹è½½ï¼Œé˜²æ­¢äº§ç”Ÿé‡å¤æ–‡ä»¶
        wget -O Xray-linux-64.zip https://github.com/XTLS/Xray-core/releases/download/v1.8.4/Xray-linux-64.zip
        unzip -o Xray-linux-64.zip
        chmod +x xray
        nohup ./xray -config config.json > /dev/null 2>&1 &
        sleep 5

    - name: Run Strategy Script
      env:
        SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }} # å»ºè®®æ”¹ç”¨ Secretsï¼Œå¦‚æœæ‡’å¾—æ”¹ï¼Œä¿æŒåŸæ ·ä¹Ÿèƒ½ç”¨
      run: python short_top10_gainers_3x_rotation.py

    - name: Save Data
      run: |
        git config --global user.name "StrategyBot"
        git config --global user.email "bot@github.com"
        
        # --- [ä¿®æ”¹ç‚¹1] åªæ·»åŠ å…³é”®æ•°æ®æ–‡ä»¶ï¼Œç»ä¸æ·»åŠ  zip å’Œ exe åƒåœ¾æ–‡ä»¶ ---
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œåªä¼šå¿½ç•¥
        git add strategy_state.json strategy_history.csv equity_curve.csv || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if [[ -n $(git status -s) ]]; then
          git commit -m "ğŸ“Š Update Data [$(date +'%Y-%m-%d %H:%M')]"
          
          # --- [ä¿®æ”¹ç‚¹2] è§£å†³å†²çªçš„æ ¸å¿ƒ ---
          # --rebase: å˜åŸºæ¨¡å¼
          # -X ours: å¦‚æœå‘ç”Ÿå†²çªï¼ˆæ¯”å¦‚csvæœ€åä¸€è¡Œæ‰“æ¶äº†ï¼‰ï¼Œå¼ºåˆ¶ä½¿ç”¨è¿œç¨‹æœåŠ¡å™¨çš„ç‰ˆæœ¬
          # è¿™æ ·è™½ç„¶å¯èƒ½ä¸¢æ‰è¿™ä¸€è½®çš„ csv è®°å½•ï¼ˆæå°æ¦‚ç‡ï¼‰ï¼Œä½†ä¿è¯äº†æµæ°´çº¿ç»å¯¹ä¸ä¼šçº¢ç¯å´©æºƒï¼
          git pull --rebase -X ours origin main
          
          git push
        else
          echo "âœ… No changes to save."
        fi
